<!DOCTYPE html>
<!-- المستند باللغة العربية وموجه من اليمين إلى اليسار -->
<html lang="ar" dir="rtl">
<head>
    <!-- إعدادات أساسية للصفحة -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم | ولاء المستقبل للمقاولات</title>
    
    <!-- استدعاء Tailwind CSS للتصميم -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- استدعاء الخط العربي (Tajawal) من خطوط جوجل -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- مكتبة SheetJS للتعامل مع ملفات اكسل -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- قسم الأنماط المخصصة (CSS) -->
    <style>
        /* تطبيق الخط العربي على كامل الصفحة */
        body { font-family: 'Tajawal', sans-serif; }

        /* تخصيص شكل شريط التمرير (Scrollbar) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* تصميم روابط القائمة الجانبية */
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; color: #d1d5db; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #1e40af; color: white; font-weight: 700; }

        /* إخفاء وإظهار أقسام المحتوى */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* أنماط النوافذ المنبثقة (Modals) */
        .modal {
            display: none; /* تكون مخفية بشكل افتراضي */
            transition: opacity 0.3s ease; /* تأثير ظهور ناعم */
        }
        .modal.active {
            display: flex; /* تظهر عند إضافة كلاس 'active' */
        }
        .modal-content-container {
            transition: transform 0.3s ease;
            transform: scale(0.95); /* تأثير تكبير عند الظهور */
        }
        .modal.active .modal-content-container {
            transform: scale(1);
        }
        
        /* تصميم مؤشر التحميل (Loader) */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* تصميم شريط التقدم للمشاريع */
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; width: 100%; overflow: hidden; }
        .progress-bar-inner { background-color: #2563eb; height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; text-align: center; color: white; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500; }
        
        /* تصميم نقاط الحالة (للمعدات) */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        
        /* تصميم عناصر المعلومات داخل البطاقات */
        .info-item { display: flex; align-items: center; gap: 0.5rem; color: #4b5563; }
        .info-item svg { width: 1rem; height: 1rem; color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- الحاوية الرئيسية للتطبيق بتقسيم Flexbox -->
    <div class="flex h-screen bg-gray-200">
        <!-- الشريط الجانبي (Sidebar) -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 space-y-6 transition-transform duration-300 -translate-x-full lg:translate-x-0">
            <!-- شعار الشركة -->
            <div class="text-center">
                <h1 class="text-2xl font-bold">ولاء المستقبل</h1>
                <p class="text-sm text-gray-400">للمقاولات</p>
            </div>
            <!-- قائمة التنقل -->
            <nav class="space-y-2">
                <a href="#" class="sidebar-link active" data-target="dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span>الرئيسية</span></a>
                <a href="#" class="sidebar-link" data-target="employees"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg><span>الموظفين</span></a>
                <a href="#" class="sidebar-link" data-target="equipment"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0117.657 18.657z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z" /></svg><span>المعدات</span></a>
                <a href="#" class="sidebar-link" data-target="projects"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg><span>المشاريع</span></a>
            </nav>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="flex-1 p-6 lg:p-10 overflow-auto bg-gray-100">
            <!-- زر إظهار/إخفاء القائمة الجانبية على الشاشات الصغيرة -->
            <button id="sidebar-toggle" class="lg:hidden mb-4 p-2 rounded-md bg-gray-700 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>

            <!-- قسم لوحة المعلومات (الرئيسية) -->
            <section id="dashboard" class="content-section active">
                 <h2 class="text-3xl font-bold text-gray-800 mb-4">لوحة المعلومات</h2>

                <!-- شريط الترحيب والتذكير -->
                <div id="dashboard-header" class="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-center gap-2">
                    <p id="greeting-message" class="text-xl font-semibold text-gray-700"></p>
                    <p class="text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full">اللهم صلِّ وسلم على نبينا محمد</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- بطاقات الإحصائيات -->
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1"><h3 class="text-xl font-semibold text-gray-700">إجمالي الموظفين</h3><p id="total-employees" class="text-4xl font-bold text-blue-600 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1"><h3 class="text-xl font-semibold text-gray-700">إجمالي المعدات</h3><p id="total-equipment" class="text-4xl font-bold text-green-600 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1"><h3 class="text-xl font-semibold text-gray-700">المشاريع القائمة</h3><p id="total-projects" class="text-4xl font-bold text-purple-600 mt-2">0</p></div>
                    
                    <!-- بطاقة الملخص الذكي -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">نظرة عامة ذكية</h3>
                        <p class="text-gray-600 mb-4">احصل على ملخص تنفيذي فوري لحالة عملياتك الحالية باستخدام الذكاء الاصطناعي.</p>
                        <div class="flex items-center">
                            <button id="generate-summary-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">✨ إنشاء ملخص تنفيذي</button>
                            <div id="summary-loader" class="loader hidden mr-4"></div>
                        </div>
                    </div>
                     <!-- بطاقة إيجاز السلامة -->
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">إيجاز السلامة اليومي</h3>
                        <p class="text-gray-600 mb-4">ابدأ كل يوم عمل بتذكير فريقك بأهم معايير السلامة.</p>
                        <div class="flex items-center">
                            <button id="generate-safety-briefing-btn" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">✨ توليد إيجاز السلامة</button>
                            <div id="safety-loader" class="loader hidden mr-4"></div>
                        </div>
                    </div>
                    <!-- بطاقة إدارة البيانات (استيراد وتصدير) -->
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">إدارة البيانات (إكسل)</h3>
                        <p class="text-gray-600 mb-4">حفظ نسخة احتياطية من بياناتك أو استعادتها من ملف إكسل.</p>
                        <div class="flex items-center gap-4">
                            <button id="export-data-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">تصدير البيانات</button>
                            <button id="import-data-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">استيراد البيانات</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- حاويات الأقسام الأخرى (سيتم ملؤها بواسطة جافاسكريبت) -->
            <section id="employees" class="content-section"></section>
            <section id="equipment" class="content-section"></section>
            <section id="projects" class="content-section"></section>
        </main>
    </div>
    
    <!-- النافذة المنبثقة الرئيسية (لإضافة وتعديل البيانات) -->
    <div id="app-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto modal-content-container">
            <div id="modal-content" class="p-8"></div>
        </div>
    </div>

    <!-- نافذة تأكيد الإجراءات (مثل الحذف) -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content-container">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 id="confirmation-message" class="mb-5 text-lg font-normal text-gray-500">هل أنت متأكد؟</h3>
                <button id="confirm-yes-btn" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">نعم, أنا متأكد</button>
                <button id="confirm-no-btn" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">لا, إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- عنصر إدخال الملفات المخفي للاستيراد -->
    <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls">

    <!-- بداية كود جافاسكريبت -->
    <script>
        // هذا الكود يتم تنفيذه بعد تحميل كامل محتوى الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- الحالة المركزية للتطبيق (State) ---
            let state = {
                employees: [],
                equipment: [],
                projects: [],
                editingId: null,
            };

            // --- التخزين المحلي (Local Storage) ---
            function saveState() {
                localStorage.setItem('dashboardData', JSON.stringify(state));
            }

            function loadState() {
                const savedData = localStorage.getItem('dashboardData');
                const defaultState = { employees: [], equipment: [], projects: [], editingId: null };
                if (savedData) {
                    try {
                         state = { ...defaultState, ...JSON.parse(savedData) };
                    } catch(e) {
                        console.error("Error parsing saved data, falling back to default.", e);
                        state = getInitialData();
                    }
                } else {
                    state = getInitialData();
                    saveState();
                }
            }
            
            // --- الوصول لعناصر الصفحة (DOM Elements) ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentSections = document.querySelectorAll('.content-section');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const appModal = document.getElementById('app-modal');
            const modalContent = document.getElementById('modal-content');
            const importFileInput = document.getElementById('import-file-input');

            // --- نافذة التأكيد (Confirmation Modal) ---
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            const confirmationMessage = document.getElementById('confirmation-message');
            let confirmCallback = null;

            function showConfirmationModal(message, onConfirm) {
                confirmationMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmationModal.classList.add('active');
            }

            function hideConfirmationModal() {
                confirmationModal.classList.remove('active');
                confirmCallback = null;
            }

            confirmYesBtn.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirmationModal();
            });
            confirmNoBtn.addEventListener('click', hideConfirmationModal);
            confirmationModal.addEventListener('click', (e) => {
                if (e.target === confirmationModal) hideConfirmationModal();
            });


            // --- استدعاء Gemini API (الذكاء الاصطناعي) ---
            async function callGeminiAPI(prompt) {
                // <--- هام جداً: تم إضافة مفتاح الـ API الخاص بك هنا
                const apiKey = "AIzaSyDKAzkV0N9KXwK4o1BQrSczN0xvCat4wU8";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "لم يتمكن الذكاء الاصطناعي من إنشاء رد.";
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    return `حدث خطأ أثناء الاتصال بالذكاء الاصطناعي: ${error.message}`;
                }
            }

            // --- التنقل بين الصفحات ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const targetId = link.getAttribute('data-target');
                    contentSections.forEach(s => s.classList.toggle('active', s.id === targetId));
                    if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
                });
            });
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));

            // --- التحكم بالنافذة المنبثقة الرئيسية ---
            function openModal(content) {
                modalContent.innerHTML = content;
                appModal.classList.add('active');
                appModal.addEventListener('click', closeModalOutside);
            }
            function closeModal() {
                appModal.classList.remove('active');
                appModal.removeEventListener('click', closeModalOutside);
                state.editingId = null;
            }
            function closeModalOutside(e) { if (e.target === appModal) closeModal(); }
            
            // --- عرض البيانات (Rendering) ---
            function renderAll() {
                renderSection('employees', 'الموظفين', getEmployeesContent);
                renderSection('equipment', 'المعدات', getEquipmentContent);
                renderSection('projects', 'المشاريع', getProjectsContent);
                updateDashboard();
                updateDashboardHeader(); // تحديث التحية عند كل إعادة رسم
            }

            function renderSection(id, title, contentFn) {
                const section = document.getElementById(id);
                if (!section) return;
                section.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-gray-800">${title}</h2>
                        <button class="add-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-type="${id}">إضافة ${title.slice(0, -1)} جديد</button>
                    </div>
                    <div class="space-y-4">${contentFn()}</div>`;
            }
            
            // --- وظائف بناء محتوى الأقسام (تصميم البطاقات) ---
            const getEmployeesContent = () => { return state.employees.map(e=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg border-r-4 border-blue-500"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="bg-blue-100 p-2 rounded-full"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div><p class="font-bold text-lg text-gray-800">${e.name||''}</p><p class="text-sm text-gray-500">${e.jobTitle||''}</p></div></div><div class="flex items-center justify-end gap-2 flex-wrap"><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="employees" data-id="${e.id}">تعديل</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="employees" data-id="${e.id}">حذف</button></div></div><div class="border-t my-3"></div><div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg><span>${e.phone||'غير محدد'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 012-2h2a2 2 0 012 2v1m-4 0h4"></path></svg><span>${e.idNumber||'غير محدد'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>تاريخ التوظيف: ${e.hireDate||'غير محدد'}</span></div></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد موظفين حالياً.</div>`; };
            const equipmentStatus = { 'يعمل': 'bg-green-500', 'صيانة': 'bg-yellow-500', 'خارج الخدمة': 'bg-red-500' };
            const getEquipmentContent = () => { return state.equipment.map(eq=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg border-r-4 border-green-500"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="bg-green-100 p-2 rounded-full"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div><div><p class="font-bold text-lg text-gray-800">${eq.name||''}</p><p class="text-sm text-gray-500">${eq.type||''}</p></div></div><div class="flex items-center justify-end gap-4"><button class="maintenance-btn font-medium text-green-600 hover:underline" data-id="${eq.id}">صيانة</button><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="equipment" data-id="${eq.id}">تعديل</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="equipment" data-id="${eq.id}">حذف</button></div></div><div class="border-t my-3"></div><div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"><div class="info-item"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg><span>الرقم التسلسلي: ${eq.serialNumber||''}</span></div><div class="info-item"><span class="status-dot ${equipmentStatus[eq.status]||'bg-gray-400'}"></span><span>الحالة: ${eq.status||''}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>تاريخ الشراء: ${eq.purchaseDate||'غير محدد'}</span></div></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد معدات حالياً.</div>`;};
            const projectStatusColors = { 'جاري العمل': 'bg-blue-100 text-blue-800', 'مرحلة التسليم': 'bg-cyan-100 text-cyan-800', 'تخطيط': 'bg-yellow-100 text-yellow-800', 'مكتمل': 'bg-green-100 text-green-800' };
            const getProjectsContent = () => { return state.projects.map(p=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg space-y-3 border-r-4 border-purple-500"><div class="flex justify-between items-start"><div><p class="font-bold text-lg text-gray-800">${p.name||''}</p><p class="text-sm text-gray-500 info-item"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span>${p.projectManager||''}</span></p></div><span class="px-2 py-1 text-xs font-semibold rounded-full ${projectStatusColors[p.status]||'bg-gray-100 text-gray-800'}">${p.status||''}</span></div><div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>${p.budget?`SAR ${parseInt(p.budget).toLocaleString()}`:'غير محدد'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>يبدأ: ${p.startDate||'-'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>ينتهي: ${p.endDate||'-'}</span></div></div><div><label class="text-xs text-gray-500">التقدم</label><div class="progress-bar"><div class="progress-bar-inner" style="width: ${p.progress||0}%">${p.progress||0}%</div></div></div><div class="border-t pt-3 flex items-center justify-end gap-4"><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="projects" data-id="${p.id}">تعديل/عرض</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="projects" data-id="${p.id}">حذف</button></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد مشاريع حالياً.</div>`;};

            // --- وظائف بناء نماذج الإدخال (Forms) ---
            const getEmployeeForm = (data = {}) => `<h3 class="text-2xl font-bold mb-6">${data.name ? 'تعديل' : 'إضافة'} موظف</h3><form id="data-form" data-type="employees" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" name="name" placeholder="الاسم الكامل" value="${data.name || ''}" class="p-2 border rounded col-span-2" required><input type="text" name="jobTitle" placeholder="المسمى الوظيفي" value="${data.jobTitle || ''}" class="p-2 border rounded"><input type="text" name="idNumber" placeholder="رقم الهوية / الإقامة" value="${data.idNumber || ''}" class="p-2 border rounded"><input type="tel" name="phone" placeholder="رقم الجوال" value="${data.phone || ''}" class="p-2 border rounded"><input type="text" name="nationality" placeholder="الجنسية" value="${data.nationality || ''}" class="p-2 border rounded"><input type="number" name="salary" placeholder="الراتب" value="${data.salary || ''}" class="p-2 border rounded"><input type="text" name="religion" placeholder="الديانة" value="${data.religion || ''}" class="p-2 border rounded"><input type="text" name="insuranceNumber" placeholder="رقم التأمين" value="${data.insuranceNumber || ''}" class="p-2 border rounded"><div><label>تاريخ التوظيف:</label><input type="date" name="hireDate" value="${data.hireDate || ''}" class="p-2 border rounded w-full"></div><div><label>تاريخ انتهاء العقد:</label><input type="date" name="contractEndDate" value="${data.contractEndDate || ''}" class="p-2 border rounded w-full"></div><div class="col-span-2 text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg mr-2">إلغاء</button></div></form>`;
            const getEquipmentForm = (data = {}) => `<h3 class="text-2xl font-bold mb-6">${data.name ? 'تعديل' : 'إضافة'} معدة</h3><form id="data-form" data-type="equipment" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" name="name" placeholder="اسم المعدة" value="${data.name || ''}" class="p-2 border rounded" required><input type="text" name="type" placeholder="النوع" value="${data.type || ''}" class="p-2 border rounded"><input type="text" name="serialNumber" placeholder="الرقم التسلسلي" value="${data.serialNumber || ''}" class="p-2 border rounded"><select name="status" class="p-2 border rounded"><option ${!data.status ? 'selected' : ''} disabled>اختر الحالة</option><option value="يعمل" ${data.status === 'يعمل' ? 'selected' : ''}>يعمل</option><option value="صيانة" ${data.status === 'صيانة' ? 'selected' : ''}>صيانة</option><option value="خارج الخدمة" ${data.status === 'خارج الخدمة' ? 'selected' : ''}>خارج الخدمة</option></select><div><label>تاريخ الشراء:</label><input type="date" name="purchaseDate" value="${data.purchaseDate || ''}" class="p-2 border rounded w-full"></div><div class="col-span-2 text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg mr-2">إلغاء</button></div></form>`;
            const getProjectForm = (data = {}) => `<h3 class="text-2xl font-bold mb-6">${data.name ? 'تعديل' : 'إضافة'} مشروع</h3><form id="data-form" data-type="projects" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" id="projectName" name="name" placeholder="اسم المشروع" value="${data.name || ''}" class="p-2 border rounded" required><input type="text" name="projectManager" placeholder="مدير المشروع" value="${data.projectManager || ''}" class="p-2 border rounded"><input type="number" name="budget" placeholder="الميزانية" value="${data.budget || ''}" class="p-2 border rounded"><select name="status" class="p-2 border rounded"><option ${!data.status ? 'selected' : ''} disabled>اختر الحالة</option><option value="تخطيط" ${data.status === 'تخطيط' ? 'selected' : ''}>تخطيط</option><option value="جاري العمل" ${data.status === 'جاري العمل' ? 'selected' : ''}>جاري العمل</option><option value="مرحلة التسليم" ${data.status === 'مرحلة التسليم' ? 'selected' : ''}>مرحلة التسليم</option><option value="مكتمل" ${data.status === 'مكتمل' ? 'selected' : ''}>مكتمل</option></select><div><label>تاريخ البدء:</label><input type="date" name="startDate" value="${data.startDate || ''}" class="p-2 border rounded w-full"></div><div><label>تاريخ الانتهاء المتوقع:</label><input type="date" name="endDate" value="${data.endDate || ''}" class="p-2 border rounded w-full"></div></div><div><label>نسبة الإنجاز: <span id="progress-value">${data.progress || 0}%</span></label><input type="range" name="progress" min="0" max="100" value="${data.progress || 0}" class="w-full" oninput="document.getElementById('progress-value').textContent = this.value + '%'"></div><textarea id="projectDesc" name="description" placeholder="وصف موجز للمشروع" class="w-full p-2 border rounded h-24">${data.description || ''}</textarea><div class="flex items-center justify-start flex-wrap gap-4"><button type="button" id="generate-tasks-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">✨ تحليل المشروع إلى مهام</button><div id="tasks-loader" class="loader hidden"></div><button type="button" id="generate-risks-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">✨ تقييم المخاطر</button><div id="risks-loader" class="loader hidden"></div></div><textarea id="projectTasks" name="tasks" placeholder="قائمة المهام المقترحة..." class="w-full p-2 border rounded bg-gray-50 h-32">${data.tasks || ''}</textarea><textarea id="projectRisks" name="risks" placeholder="المخاطر المحتملة..." class="w-full p-2 border rounded bg-gray-50 h-32">${data.risks || ''}</textarea><div class="text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg mr-2">إلغاء</button></div></form>`;

            // --- وظائف استيراد وتصدير البيانات (Excel) ---
            const employeeHeaders = { id: 'المعرف', name: 'الاسم الكامل', jobTitle: 'المسمى الوظيفي', idNumber: 'رقم الهوية/الإقامة', phone: 'الجوال', nationality: 'الجنسية', salary: 'الراتب', religion: 'الديانة', insuranceNumber: 'رقم التأمين', hireDate: 'تاريخ التوظيف', contractEndDate: 'نهاية العقد' };
            const equipmentHeaders = { id: 'المعرف', name: 'اسم المعدة', type: 'النوع', serialNumber: 'الرقم التسلسلي', status: 'الحالة', purchaseDate: 'تاريخ الشراء' };
            const projectHeaders = { id: 'المعرف', name: 'اسم المشروع', projectManager: 'مدير المشروع', budget: 'الميزانية', status: 'الحالة', progress: 'نسبة الإنجاز', startDate: 'تاريخ البدء', endDate: 'تاريخ الانتهاء', description: 'الوصف' };
            
            function exportData() {
                const wb = XLSX.utils.book_new();
                const date = new Date().toISOString().split('T')[0];
                const fileName = `walaa-almustaqbal-data-${date}.xlsx`;

                const createStyledSheet = (data, headerMapping, sheetName) => {
                    const dataForSheet = data.map(row => {
                        const newRow = {};
                        for (const key in headerMapping) {
                            if (Object.prototype.hasOwnProperty.call(row, key)) {
                                newRow[headerMapping[key]] = row[key] === null || row[key] === undefined ? '' : row[key]; 
                            }
                        }
                        return newRow;
                    });

                    const ws = XLSX.utils.json_to_sheet(dataForSheet);

                    const headerStyle = { font: { name: 'Tajawal', sz: 12, bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "1F4E78" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
                    const cellStyle = { font: { name: 'Tajawal', sz: 11 }, border: { top: { style: "thin", color: { rgb: "D9D9D9" } }, bottom: { style: "thin", color: { rgb: "D9D9D9" } }, left: { style: "thin", color: { rgb: "D9D9D9" } }, right: { style: "thin", color: { rgb: "D9D9D9" } } } };

                    if (dataForSheet.length > 0) {
                        const columnWidths = Object.keys(dataForSheet[0]).map(header => ({ wch: Math.max(header.length, ...dataForSheet.map(row => (row[header] ? String(row[header]).length : 0))) + 5 }));
                        ws['!cols'] = columnWidths;
                    }

                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                            if (!ws[cell_ref]) continue; 
                            ws[cell_ref].s = (R === 0) ? headerStyle : cellStyle;
                        }
                    }
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                };

                createStyledSheet(state.employees, employeeHeaders, "الموظفين");
                createStyledSheet(state.equipment, equipmentHeaders, "المعدات");
                createStyledSheet(state.projects, projectHeaders, "المشاريع");
                
                XLSX.writeFile(wb, fileName);
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const newState = { employees: [], equipment: [], projects: [], editingId: null };
                        
                        const reverseEmployeeHeaders = Object.fromEntries(Object.entries(employeeHeaders).map(([k, v]) => [v, k]));
                        const reverseEquipmentHeaders = Object.fromEntries(Object.entries(equipmentHeaders).map(([k, v]) => [v, k]));
                        const reverseProjectHeaders = Object.fromEntries(Object.entries(projectHeaders).map(([k, v]) => [v, k]));
                        
                        const mapSheetData = (sheetData, reverseMap) => {
                            return sheetData.map(row => {
                                const newRow = {};
                                for (const key in row) {
                                    if (reverseMap[key]) {
                                        newRow[reverseMap[key]] = row[key];
                                    }
                                }
                                if (!newRow.id) {
                                    newRow.id = Date.now().toString() + Math.random().toString(16).slice(2);
                                } else {
                                    newRow.id = String(newRow.id);
                                }
                                return newRow;
                            });
                        };

                        if (workbook.Sheets["الموظفين"]) newState.employees = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["الموظفين"]), reverseEmployeeHeaders);
                        if (workbook.Sheets["المعدات"]) newState.equipment = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["المعدات"]), reverseEquipmentHeaders);
                        if (workbook.Sheets["المشاريع"]) newState.projects = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["المشاريع"]), reverseProjectHeaders);

                        if (newState.employees.length === 0 && newState.equipment.length === 0 && newState.projects.length === 0) {
                             throw new Error("الملف فارغ أو لا يحتوي على الأوراق المطلوبة بالأسماء الصحيحة.");
                        }

                        showConfirmationModal("سيتم استبدال البيانات الحالية ببيانات ملف الإكسل. هل أنت متأكد؟", () => {
                            state = newState;
                            saveState();
                            renderAll();
                            openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-green-600 mb-4">نجاح</h3><p>تم استيراد البيانات بنجاح.</p><button onclick="closeModal()" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg">حسنًا</button></div>`);
                        });

                    } catch (error) {
                        openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-red-600 mb-4">خطأ</h3><p>فشل استيراد الملف: ${error.message}</p><button onclick="closeModal()" class="mt-6 bg-gray-300 px-6 py-2 rounded-lg">إغلاق</button></div>`);
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.onerror = () => {
                    openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-red-600 mb-4">خطأ</h3><p>فشل قراءة الملف.</p><button onclick="closeModal()" class="mt-6 bg-gray-300 px-6 py-2 rounded-lg">إغلاق</button></div>`);
                    importFileInput.value = '';
                };
                reader.readAsArrayBuffer(file);
            }

            // --- معالج الأحداث الرئيسي (Event Handlers) ---
            importFileInput.addEventListener('change', importData);

            document.body.addEventListener('click', async (e) => {
                
                if (e.target.matches('.add-btn')) {
                    const type = e.target.dataset.type;
                    state.editingId = null; 
                    if (type === 'employees') openModal(getEmployeeForm());
                    if (type === 'equipment') openModal(getEquipmentForm());
                    if (type === 'projects') openModal(getProjectForm());
                }
                if (e.target.matches('.edit-btn')) {
                    const { type, id } = e.target.dataset;
                    const data = state[type].find(item => item.id === id);
                    if (data) {
                        state.editingId = id;
                        if (type === 'employees') openModal(getEmployeeForm(data));
                        if (type === 'equipment') openModal(getEquipmentForm(data));
                        if (type === 'projects') openModal(getProjectForm(data));
                    }
                }
                if (e.target.matches('.delete-btn')) {
                    const { type, id } = e.target.dataset;
                    const itemToDelete = state[type].find(item => item.id === id);
                    const itemName = itemToDelete ? `"${itemToDelete.name}"` : 'هذا العنصر';
                    showConfirmationModal(`هل أنت متأكد من حذف ${itemName}؟`, () => {
                        state[type] = state[type].filter(item => item.id !== id);
                        saveState();
                        renderAll();
                    });
                }
                if (e.target.matches('.maintenance-btn')) {
                    const eqId = e.target.dataset.id;
                    const eq = state.equipment.find(item => item.id === eqId);
                    if (!eq) return;

                    const renderHistory = (logs) => (!logs || logs.length === 0) ? '<p class="text-gray-500 text-center p-4">لا توجد سجلات.</p>' : [...logs].reverse().map(log => `<div class="border-b p-2 last:border-b-0"><p class="font-semibold text-sm text-gray-800">${log.date}</p><p class="text-gray-600 whitespace-pre-wrap text-sm">${log.note}</p></div>`).join('');

                    openModal(`<h3 class="text-2xl font-bold mb-4">سجل الصيانة لـ ${eq.name}</h3><div class="mb-4"><h4 class="text-lg font-semibold text-gray-700 mb-2">السجل الحالي</h4><div id="maintenance-history" class="bg-gray-50 rounded-lg border max-h-48 overflow-y-auto">${renderHistory(eq.maintenanceLog)}</div></div><div class="mb-6"><h4 class="text-lg font-semibold text-gray-700 mb-2">إضافة سجل جديد</h4><textarea id="manual-maintenance-note" class="w-full p-2 border rounded" placeholder="..."></textarea><button id="save-manual-note-btn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">حفظ</button></div><div><h4 class="text-lg font-semibold text-gray-700 mb-2">مساعد الصيانة الذكي</h4><div class="flex items-center"><button id="generate-maintenance-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">✨ اقتراح</button><div id="maintenance-loader" class="loader hidden mr-4"></div></div><div id="maintenance-result-container" class="hidden mt-4"><label class="block text-sm font-medium text-gray-700 mb-2">الخطة المقترحة:</label><div id="maintenance-result" class="p-4 bg-gray-100 rounded-lg whitespace-pre-wrap"></div><button id="save-ai-note-btn" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">إضافة للسجل</button></div></div>`);
                    
                    const updateAndReRenderHistory = () => { document.getElementById('maintenance-history').innerHTML = renderHistory(eq.maintenanceLog); }
                    const saveMaintenanceLog = (newLog) => { if (!eq.maintenanceLog) eq.maintenanceLog = []; eq.maintenanceLog.push(newLog); saveState(); updateAndReRenderHistory(); };

                    document.getElementById('save-manual-note-btn').onclick = () => { const note = document.getElementById('manual-maintenance-note'); if (note.value.trim()) { saveMaintenanceLog({ date: new Date().toISOString().split('T')[0], note: note.value.trim() }); note.value = ''; } };
                    document.getElementById('save-ai-note-btn').onclick = () => { const note = document.getElementById('maintenance-result'); if (note.textContent.trim()) { saveMaintenanceLog({ date: new Date().toISOString().split('T')[0], note: `خطة مقترحة:\n${note.textContent.trim()}` }); document.getElementById('maintenance-result-container').classList.add('hidden'); note.textContent = ''; } };
                    document.getElementById('generate-maintenance-btn').onclick = async (btnEvent) => {
                        const loader = document.getElementById('maintenance-loader');
                        const resultContainer = document.getElementById('maintenance-result-container');
                        const resultDiv = document.getElementById('maintenance-result');
                        btnEvent.target.disabled = true; loader.classList.remove('hidden');
                        const prompt = `Provide a simple, bullet-pointed maintenance schedule for "${eq.name}". Respond in Arabic.`;
                        resultDiv.textContent = await callGeminiAPI(prompt);
                        resultContainer.classList.remove('hidden');
                        loader.classList.add('hidden'); btnEvent.target.disabled = false;
                    };
                }
                
                if (e.target.id === 'export-data-btn') exportData();
                if (e.target.id === 'import-data-btn') importFileInput.click();
                
                if (e.target.id === 'generate-summary-btn' || e.target.id === 'generate-safety-briefing-btn') {
                    const isSummary = e.target.id === 'generate-summary-btn';
                    const loader = document.getElementById(isSummary ? 'summary-loader' : 'safety-loader');
                    loader.classList.remove('hidden'); e.target.disabled = true;
                    const today = new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const prompt = isSummary ? `As manager for 'Walaa Al-Mustaqbal', provide a brief, professional executive summary in Arabic. Data: ${state.employees.length} employees, ${state.equipment.length} equipment, ${state.projects.length} projects.` : `As a safety officer in Hail, Saudi Arabia, provide a brief, practical safety topic for today's briefing. Respond in Arabic.`;
                    const title = isSummary ? "الملخص التنفيذي" : `إيجاز السلامة ليوم ${today}`;
                    const content = await callGeminiAPI(prompt);
                    openModal(`<h3 class="text-2xl font-bold mb-4">${title}</h3><div class="p-4 bg-gray-100 rounded-lg whitespace-pre-wrap">${content}</div><div class="text-left mt-4"><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg">إغلاق</button></div>`);
                    loader.classList.add('hidden'); e.target.disabled = false;
                }
                if (e.target.id === 'generate-tasks-btn' || e.target.id === 'generate-risks-btn') {
                    const name = document.getElementById('projectName').value;
                    if (!name) { alert('يرجى إدخال اسم المشروع أولاً.'); return; }
                    const desc = document.getElementById('projectDesc').value;
                    const isTasks = e.target.id === 'generate-tasks-btn';
                    const loader = document.getElementById(isTasks ? 'tasks-loader' : 'risks-loader');
                    const output = document.getElementById(isTasks ? 'projectTasks' : 'projectRisks');
                    const prompt = isTasks ? `For project "${name}" (${desc}), create an actionable task list in Arabic.` : `For project "${name}" (${desc}), list potential on-site risks in Arabic.`;
                    loader.classList.remove('hidden'); e.target.disabled = true;
                    output.value = await callGeminiAPI(prompt);
                    loader.classList.add('hidden'); e.target.disabled = false;
                }
            });

            // --- معالجة إرسال النماذج ---
            appModal.addEventListener('submit', (e) => {
                 if (e.target.id === 'data-form') {
                    e.preventDefault();
                    const form = e.target, type = form.dataset.type, formData = new FormData(form), newEntry = Object.fromEntries(formData.entries());
                    if (state.editingId) {
                        const index = state[type].findIndex(item => item.id === state.editingId);
                        if (index !== -1) state[type][index] = { ...state[type][index], ...newEntry };
                    } else {
                        newEntry.id = Date.now().toString();
                        state[type].push(newEntry);
                    }
                    saveState(); renderAll(); closeModal();
                }
            });
            
            // --- بداية تشغيل التطبيق (Initialization) ---
            function updateDashboard() {
                document.getElementById('total-employees').textContent = state.employees.length;
                document.getElementById('total-equipment').textContent = state.equipment.length;
                document.getElementById('total-projects').textContent = state.projects.length;
            }

            function updateDashboardHeader() {
                const greetingEl = document.getElementById('greeting-message');
                if (!greetingEl) return;
                const hour = new Date().getHours();
                let greeting = '';
                if (hour >= 5 && hour < 12) { greeting = 'صباح الخير'; } 
                else if (hour >= 12 && hour < 18) { greeting = 'طاب يومك'; } 
                else { greeting = 'مساء الخير'; }
                greetingEl.textContent = greeting;
            }

            window.closeModal = closeModal;
            function getInitialData() {
                return { employees: [{id: '1', name: 'عبدالله بن محمد الغامدي', jobTitle: 'مدير مشروع', idNumber: '1098765432', phone: '0501234567', hireDate: '2022-08-15', salary: '15000', nationality: 'سعودي', contractEndDate: '2025-08-14'},{id: '2', name: 'محمد إقبال خان', jobTitle: 'مشرف عمال', idNumber: '2456789123', phone: '0559876543', hireDate: '2021-05-20', salary: '6000', nationality: 'باكستاني', contractEndDate: '2024-05-19'},{id: '3', name: 'علي حسن المصري', jobTitle: 'مهندس مدني', idNumber: '2345678901', phone: '0532109876', hireDate: '2023-01-10', salary: '11000', nationality: 'مصري', contractEndDate: '2026-01-09'},], equipment: [{id: 'eq1', name: 'حفار كوماتسو PC200', type: 'معدات ثقيلة', serialNumber: 'KM-45332', status: 'يعمل', purchaseDate: '2020-03-12', maintenanceLog: [{date: '2024-04-10', note: 'تغيير زيت وفلاتر دوري'}]},{id: 'eq2', name: 'شيول كاتربيلر 950H', type: 'معدات ثقيلة', serialNumber: 'CAT-950H-0199', status: 'صيانة', purchaseDate: '2019-11-05', maintenanceLog: []},{id: 'eq3', name: 'مولد كهرباء بيركنز', type: 'مولدات', serialNumber: 'PK-GENER-5884', status: 'يعمل', purchaseDate: '2022-02-28', maintenanceLog: []},], projects: [{id: 'proj1', name: 'مشروع إنشاء مبنى تجاري - حي السلام', projectManager: 'عبدالله بن محمد الغامدي', budget: '5500000', startDate: '2023-09-01', endDate: '2025-03-30', status: 'جاري العمل', progress: '45'},{id: 'proj2', name: 'مشروع سفلتة ورصف طرق - مخطط الياسمين', projectManager: 'علي حسن المصري', budget: '12000000', startDate: '2024-01-15', endDate: '2024-12-20', status: 'جاري العمل', progress: '70'},{id: 'proj3', name: 'تجهيز موقع مشروع فلل سكنية', projectManager: 'عبدالله بن محمد الغامدي', budget: '750000', startDate: '2024-05-10', endDate: '2024-08-10', status: 'تخطيط', progress: '5'},] };
            }

            loadState();
            renderAll();
        });
    </script>
</body>
</html>

