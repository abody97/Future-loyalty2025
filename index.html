<!DOCTYPE html>
<!-- المستند باللغة العربية وموجه من اليمين إلى اليسار -->
<html lang="ar" dir="rtl">
<head>
    <!-- إعدادات أساسية للصفحة -->
    <meta charset="UTF-8">
    <!-- السطر الأهم للتصميم المتجاوب: يخبر المتصفح بكيفية التعامل مع أبعاد الصفحة والتكبير -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم | ولاء المستقبل للمقاولات</title>
    
    <!-- استدعاء Tailwind CSS للتصميم -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- استدعاء الخط العربي (Tajawal) من خطوط جوجل -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- مكتبة SheetJS للتعامل مع ملفات اكسل -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- قسم الأنماط المخصصة (CSS) -->
    <style>
        /* تطبيق الخط العربي على كامل الصفحة */
        body { font-family: 'Tajawal', sans-serif; }

        /* تخصيص شكل شريط التمرير (Scrollbar) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* تصميم روابط القائمة الجانبية */
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; color: #d1d5db; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #1e40af; color: white; font-weight: 700; }

        /* إخفاء وإظهار أقسام المحتوى */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* أنماط النوافذ المنبثقة (Modals) */
        .modal {
            display: none; /* تكون مخفية بشكل افتراضي */
            transition: opacity 0.3s ease; /* تأثير ظهور ناعم */
        }
        .modal.active {
            display: flex; /* تظهر عند إضافة كلاس 'active' */
        }
        .modal-content-container {
            transition: transform 0.3s ease;
            transform: scale(0.95); /* تأثير تكبير عند الظهور */
        }
        .modal.active .modal-content-container {
            transform: scale(1);
        }
        
        /* تصميم مؤشر التحميل (Loader) */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* تصميم شريط التقدم للمشاريع */
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; width: 100%; overflow: hidden; }
        .progress-bar-inner { background-color: #2563eb; height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; text-align: center; color: white; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500; }
        
        /* تصميم نقاط الحالة (للمعدات) */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        
        /* تصميم عناصر المعلومات داخل البطاقات */
        .info-item { display: flex; align-items: center; gap: 0.5rem; color: #4b5563; }
        .info-item svg { width: 1rem; height: 1rem; color: #9ca3af; }

        /* تصميم تبويبات النافذة المنبثقة */
        .tab-button { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 500; }
        .tab-button.active { color: #1e40af; border-color: #1e40af; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- الحاوية الرئيسية للتطبيق بتقسيم Flexbox -->
    <div class="flex h-screen bg-gray-200">
        <!-- الشريط الجانبي (Sidebar) -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 space-y-6 transition-transform duration-300 -translate-x-full lg:translate-x-0 z-20">
            <!-- شعار الشركة -->
            <div class="text-center">
                <h1 class="text-2xl font-bold">ولاء المستقبل</h1>
                <p class="text-sm text-gray-400">للمقاولات</p>
            </div>
            <!-- قائمة التنقل -->
            <nav class="space-y-2">
                <a href="#" class="sidebar-link active" data-target="dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span>الرئيسية</span></a>
                <a href="#" class="sidebar-link" data-target="employees"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>الموظفين</span></a>
                <a href="#" class="sidebar-link" data-target="equipment"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span>المعدات</span></a>
                <a href="#" class="sidebar-link" data-target="projects"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg><span>المشاريع</span></a>
                 <a href="#" class="sidebar-link" data-target="finance"><svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg><span>المالية</span></a>
            </nav>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="flex-1 p-4 sm:p-6 lg:p-10 overflow-auto bg-gray-100">
            <!-- زر إظهار/إخفاء القائمة الجانبية على الشاشات الصغيرة -->
            <button id="sidebar-toggle" class="lg:hidden mb-4 p-2 rounded-md bg-gray-700 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>

            <!-- قسم لوحة المعلومات (الرئيسية) -->
            <section id="dashboard" class="content-section active">
                 <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">لوحة المعلومات</h2>

                <!-- شريط الترحيب والتذكير -->
                <div id="dashboard-header" class="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-center gap-2">
                    <p id="greeting-message" class="text-lg sm:text-xl font-semibold text-gray-700"></p>
                    <p class="text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full">اللهم صلِّ وسلم على نبينا محمد</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- بطاقات الإحصائيات -->
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1 flex justify-between items-center"><div class="text-blue-500 bg-blue-100 rounded-full p-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><div><h3 class="text-xl font-semibold text-gray-700 text-left">إجمالي الموظفين</h3><p id="total-employees" class="text-4xl font-bold text-blue-600 mt-2 text-left">0</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1 flex justify-between items-center"><div class="text-green-500 bg-green-100 rounded-full p-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg></div><div><h3 class="text-xl font-semibold text-gray-700 text-left">إجمالي المعدات</h3><p id="total-equipment" class="text-4xl font-bold text-green-600 mt-2 text-left">0</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg hover:-translate-y-1 flex justify-between items-center"><div class="text-purple-500 bg-purple-100 rounded-full p-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div><div><h3 class="text-xl font-semibold text-gray-700 text-left">المشاريع القائمة</h3><p id="total-projects" class="text-4xl font-bold text-purple-600 mt-2 text-left">0</p></div></div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 mb-4">نظرة عامة ذكية</h3><p class="text-gray-600 mb-4">احصل على ملخص تنفيذي فوري لحالة عملياتك الحالية.</p><button id="generate-summary-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">✨ إنشاء ملخص تنفيذي</button></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 mb-4">إيجاز السلامة اليومي</h3><p class="text-gray-600 mb-4">ابدأ كل يوم عمل بتذكير فريقك بأهم معايير السلامة.</p><button id="generate-safety-briefing-btn" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition w-full sm:w-auto">✨ توليد إيجاز السلامة</button></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 mb-4">إدارة البيانات (إكسل)</h3><p class="text-gray-600 mb-4">حفظ نسخة احتياطية من بياناتك أو استعادتها من ملف إكسل.</p><div class="flex flex-col sm:flex-row items-center gap-4"><button id="export-data-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">تصدير</button><button id="import-data-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition w-full sm:w-auto">استيراد</button></div></div>
                </div>
            </section>

            <!-- حاويات الأقسام الأخرى -->
            <section id="employees" class="content-section"></section>
            <section id="equipment" class="content-section"></section>
            <section id="projects" class="content-section"></section>
            <section id="finance" class="content-section"></section>
        </main>
    </div>
    
    <!-- النافذة المنبثقة الرئيسية -->
    <div id="app-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg md:max-w-2xl lg:max-w-4xl max-h-full overflow-y-auto modal-content-container">
            <div id="modal-content" class="p-6 sm:p-8"></div>
        </div>
    </div>

    <!-- نافذة تأكيد الإجراءات -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content-container">
            <div class="p-6 text-center"><svg class="mx-auto mb-4 w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><h3 id="confirmation-message" class="mb-5 text-lg font-normal text-gray-500"></h3><button id="confirm-yes-btn" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">نعم</button><button id="confirm-no-btn" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">إلغاء</button></div>
        </div>
    </div>
    
    <!-- عنصر إدخال الملفات المخفي -->
    <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls">

    <!-- بداية كود جافاسكريبت -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let state = { employees: [], equipment: [], projects: [], expenses: [], searchTerms: { employees: '', equipment: '', projects: '' }, editingId: null, };
            function saveState() { localStorage.setItem('dashboardData', JSON.stringify(state)); }
            function loadState() { const savedData = localStorage.getItem('dashboardData'); const defaultState = { employees: [], equipment: [], projects: [], expenses:[], searchTerms: { employees: '', equipment: '', projects: '' }, editingId: null }; if (savedData) { try { state = { ...defaultState, ...JSON.parse(savedData) }; } catch(e) { console.error("Error loading state:", e); state = getInitialData(); } } else { state = getInitialData(); saveState(); } }
            
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentSections = document.querySelectorAll('.content-section');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const appModal = document.getElementById('app-modal');
            const modalContent = document.getElementById('modal-content');
            const importFileInput = document.getElementById('import-file-input');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            const confirmationMessage = document.getElementById('confirmation-message');
            let confirmCallback = null;

            function showConfirmationModal(message, onConfirm) { confirmationMessage.textContent = message; confirmCallback = onConfirm; confirmationModal.classList.add('active'); }
            function hideConfirmationModal() { confirmationModal.classList.remove('active'); confirmCallback = null; }
            confirmYesBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmationModal(); });
            confirmNoBtn.addEventListener('click', hideConfirmationModal);
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) hideConfirmationModal(); });

            async function callGeminiAPI(prompt) { const apiKey = "AIzaSyCpC8Y13DDMXXr5OtqtyR_qFlUQ3F8udBA"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: prompt }] }], }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response from AI."; } catch (error) { console.error('Gemini API Error:', error); return `Error: ${error.message}`; } }

            sidebarLinks.forEach(link => { link.addEventListener('click', e => { e.preventDefault(); sidebarLinks.forEach(l => l.classList.remove('active')); link.classList.add('active'); const targetId = link.getAttribute('data-target'); contentSections.forEach(s => s.classList.toggle('active', s.id === targetId)); if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full'); }); });
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));

            function openModal(content) { modalContent.innerHTML = content; appModal.classList.add('active'); appModal.addEventListener('click', closeModalOutside); }
            function closeModal() { appModal.classList.remove('active'); appModal.removeEventListener('click', closeModalOutside); state.editingId = null; }
            function closeModalOutside(e) { if (e.target === appModal) closeModal(); }
            
            function renderAll() {
                renderSection('employees', 'الموظفين', getEmployeesContent);
                renderSection('equipment', 'المعدات', getEquipmentContent);
                renderSection('projects', 'المشاريع', getProjectsContent);
                renderFinanceSection();
                updateDashboard();
                updateDashboardHeader();
            }

            function renderSection(id, title, contentFn) {
                const section = document.getElementById(id);
                if (!section) return;
                section.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"><div><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">${title}</h2></div><div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto"><div class="relative w-full sm:w-64"><input type="search" class="search-input p-2 border rounded-lg w-full pr-8" placeholder="بحث..." data-type="${id}" value="${state.searchTerms[id] || ''}"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div><button class="add-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex-shrink-0 flex items-center justify-center gap-2 w-full sm:w-auto" data-type="${id}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span>إضافة</span></button></div></div><div class="space-y-4" id="${id}-list">${contentFn()}</div>`;
            }
            
            function formatDate(dateString) { if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return '-'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }

            const getEmployeesContent = () => { const term = (state.searchTerms.employees || '').toLowerCase(); const filtered = state.employees.filter(e => e.name?.toLowerCase().includes(term) || e.jobTitle?.toLowerCase().includes(term) || e.idNumber?.includes(term)); return filtered.map(e=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg border-r-4 border-blue-500"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex items-center gap-3"><div class="bg-blue-100 p-2 rounded-full flex-shrink-0"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div><p class="font-bold text-lg text-gray-800">${e.name||''}</p><p class="text-sm text-gray-500">${e.jobTitle||''}</p></div></div><div class="flex items-center justify-end gap-2 flex-wrap self-end sm:self-center"><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="employees" data-id="${e.id}">تعديل</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="employees" data-id="${e.id}">حذف</button></div></div><div class="border-t my-3"></div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm"><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg><span>${e.phone||'-'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 012-2h2a2 2 0 012 2v1m-4 0h4"></path></svg><span>${e.idNumber||'-'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>التوظيف: ${formatDate(e.hireDate)}</span></div></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد موظفين. أضف موظفاً جديداً للبدء.</div>`; };
            const equipmentStatus = { 'يعمل': 'bg-green-500', 'صيانة': 'bg-yellow-500', 'خارج الخدمة': 'bg-red-500' };
            const getEquipmentContent = () => { const term = (state.searchTerms.equipment || '').toLowerCase(); const filtered = state.equipment.filter(eq => eq.name?.toLowerCase().includes(term) || eq.serialNumber?.toLowerCase().includes(term)); return filtered.map(eq=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg border-r-4 border-green-500"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex items-center gap-3"><div class="bg-green-100 p-2 rounded-full flex-shrink-0"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div><div><p class="font-bold text-lg text-gray-800">${eq.name||''}</p><p class="text-sm text-gray-500">${eq.type||''}</p></div></div><div class="flex items-center justify-end gap-2 sm:gap-4 flex-wrap self-end sm:self-center"><button class="maintenance-btn font-medium text-green-600 hover:underline" data-id="${eq.id}">صيانة</button><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="equipment" data-id="${eq.id}">تعديل</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="equipment" data-id="${eq.id}">حذف</button></div></div><div class="border-t my-3"></div><div class="grid grid-cols-2 lg:grid-cols-3 gap-4 text-sm"><div class="info-item"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg><span>التسلسلي: ${eq.serialNumber||''}</span></div><div class="info-item"><span class="status-dot ${equipmentStatus[eq.status]||'bg-gray-400'}"></span><span>التشغيل: ${eq.status||''}</span></div><div class="info-item"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>الحالة: ${eq.condition || '-'}</span></div><div class="info-item"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>الممشاء: ${eq.mileage ? eq.mileage.toLocaleString() : '-'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>الشراء: ${formatDate(eq.purchaseDate)}</span></div></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد معدات تطابق البحث.</div>`;};
            const projectStatusColors = { 'جاري العمل': 'bg-blue-100 text-blue-800', 'مرحلة التسليم': 'bg-cyan-100 text-cyan-800', 'تخطيط': 'bg-yellow-100 text-yellow-800', 'مكتمل': 'bg-green-100 text-green-800' };
            const getProjectsContent = () => { const term = (state.searchTerms.projects || '').toLowerCase(); const filtered = state.projects.filter(p => p.name?.toLowerCase().includes(term) || p.projectManager?.toLowerCase().includes(term)); return filtered.map(p=>`<div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg space-y-3 border-r-4 border-purple-500"><div class="flex flex-col sm:flex-row justify-between items-start gap-2"><div class="flex-grow"><p class="font-bold text-lg text-gray-800">${p.name||''}</p><p class="text-sm text-gray-500 info-item"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span>${p.projectManager||''}</span></p></div><span class="px-2 py-1 text-xs font-semibold rounded-full self-start sm:self-center ${projectStatusColors[p.status]||'bg-gray-100 text-gray-800'}">${p.status||''}</span></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm mt-3 pt-3 border-t"><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>${p.budget?`SAR ${parseInt(p.budget).toLocaleString()}`:'-'}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>البدء: ${formatDate(p.startDate)}</span></div><div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>الانتهاء: ${formatDate(p.endDate)}</span></div></div><div class="mt-3"><label class="text-xs text-gray-500">التقدم</label><div class="progress-bar"><div class="progress-bar-inner" style="width: ${p.progress||0}%">${p.progress||0}%</div></div></div><div class="border-t pt-3 mt-3 flex items-center justify-end gap-4"><button class="edit-btn font-medium text-blue-600 hover:underline" data-type="projects" data-id="${p.id}">تعديل/عرض</button><button class="delete-btn font-medium text-red-600 hover:underline" data-type="projects" data-id="${p.id}">حذف</button></div></div>`).join('') || `<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">لا يوجد مشاريع تطابق البحث.</div>`;};
            
            const getEmployeeForm = (data = {}) => `<h3 class="text-2xl font-bold mb-6">${data.name ? 'تعديل' : 'إضافة'} موظف</h3><form id="data-form" data-type="employees" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" name="name" placeholder="الاسم الكامل" value="${data.name || ''}" class="p-2 border rounded col-span-2" required><input type="text" name="jobTitle" placeholder="المسمى الوظيفي" value="${data.jobTitle || ''}" class="p-2 border rounded"><input type="text" name="idNumber" placeholder="رقم الهوية / الإقامة" value="${data.idNumber || ''}" class="p-2 border rounded"><input type="tel" name="phone" placeholder="رقم الجوال" value="${data.phone || ''}" class="p-2 border rounded"><input type="text" name="nationality" placeholder="الجنسية" value="${data.nationality || ''}" class="p-2 border rounded"><input type="number" name="salary" placeholder="الراتب" value="${data.salary || ''}" class="p-2 border rounded"><input type="text" name="religion" placeholder="الديانة" value="${data.religion || ''}" class="p-2 border rounded"><input type="text" name="insuranceNumber" placeholder="رقم التأمين" value="${data.insuranceNumber || ''}" class="p-2 border rounded"><div><label>تاريخ التوظيف:</label><input type="date" name="hireDate" value="${data.hireDate || ''}" class="p-2 border rounded w-full"></div><div><label>تاريخ انتهاء العقد:</label><input type="date" name="contractEndDate" value="${data.contractEndDate || ''}" class="p-2 border rounded w-full"></div><div class="col-span-2 text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg mr-2">إلغاء</button></div></form>`;
            const getEquipmentForm = (data = {}) => `<h3 class="text-2xl font-bold mb-6">${data.name ? 'تعديل' : 'إضافة'} معدة</h3><form id="data-form" data-type="equipment" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" name="name" placeholder="اسم المعدة" value="${data.name || ''}" class="p-2 border rounded col-span-2" required><input type="text" name="type" placeholder="النوع" value="${data.type || ''}" class="p-2 border rounded"><input type="text" name="serialNumber" placeholder="الرقم التسلسلي" value="${data.serialNumber || ''}" class="p-2 border rounded"><select name="status" class="p-2 border rounded"><option ${!data.status ? 'selected' : ''} disabled>اختر الحالة التشغيلية</option><option value="يعمل" ${data.status === 'يعمل' ? 'selected' : ''}>يعمل</option><option value="صيانة" ${data.status === 'صيانة' ? 'selected' : ''}>صيانة</option><option value="خارج الخدمة" ${data.status === 'خارج الخدمة' ? 'selected' : ''}>خارج الخدمة</option></select><select name="condition" class="p-2 border rounded"><option ${!data.condition ? 'selected' : ''} disabled>اختر حالة المعدة</option><option value="جديدة" ${data.condition === 'جديدة' ? 'selected' : ''}>جديدة</option><option value="مستخدمة" ${data.condition === 'مستخدمة' ? 'selected' : ''}>مستخدمة</option></select><input type="number" name="mileage" placeholder="الممشاء / ساعات التشغيل" value="${data.mileage || ''}" class="p-2 border rounded"><div><label>تاريخ الشراء:</label><input type="date" name="purchaseDate" value="${data.purchaseDate || ''}" class="p-2 border rounded w-full"></div><div class="col-span-2 text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button><button type="button" onclick="closeModal()" class="bg-gray-300 px-6 py-2 rounded-lg mr-2">إلغاء</button></div></form>`;
            const getProjectForm = (data = {}) => {
                const expensesForProject = state.expenses.filter(ex => ex.projectId === data.id);
                const totalExpenses = expensesForProject.reduce((sum, ex) => sum + parseFloat(ex.amount || 0), 0);
                const expenseRows = expensesForProject.map(ex => `<tr class="border-b"><td class="p-2">${formatDate(ex.date)}</td><td class="p-2">${ex.description}</td><td class="p-2">${parseFloat(ex.amount).toLocaleString()} SAR</td><td class="p-2"><button class="delete-expense-btn text-red-500 hover:underline" data-id="${ex.id}" data-project-id="${data.id}">حذف</button></td></tr>`).join('') || `<tr><td colspan="4" class="p-4 text-center text-gray-500">لا توجد مصروفات مسجلة.</td></tr>`;
                return `<div class="flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">${data.name ? 'تعديل مشروع' : 'إضافة مشروع'}</h3><button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2 text-2xl">&times;</button></div><div class="border-b border-gray-200 mb-4"><nav class="-mb-px flex gap-6" id="modal-tabs">${['التفاصيل', 'المهام والمخاطر', 'المصروفات'].map((tab, i) => `<button type="button" class="tab-button ${i===0 ? 'active' : ''}" data-target="tab-${i+1}">${tab}</button>`).join('')}</nav></div><div id="tab-1" class="tab-content active space-y-4"><form id="data-form" data-type="projects" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><input type="text" id="projectName" name="name" placeholder="اسم المشروع" value="${data.name || ''}" class="p-2 border rounded" required><input type="text" name="projectManager" placeholder="مدير المشروع" value="${data.projectManager || ''}" class="p-2 border rounded"><input type="number" name="budget" placeholder="الميزانية" value="${data.budget || ''}" class="p-2 border rounded"><select name="status" class="p-2 border rounded"><option selected disabled>اختر الحالة</option>${['تخطيط', 'جاري العمل', 'مرحلة التسليم', 'مكتمل'].map(s=>`<option value="${s}" ${data.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select><div><label>تاريخ البدء:</label><input type="date" name="startDate" value="${data.startDate || ''}" class="p-2 border rounded w-full"></div><div><label>الانتهاء المتوقع:</label><input type="date" name="endDate" value="${data.endDate || ''}" class="p-2 border rounded w-full"></div></div><div><label>نسبة الإنجاز: <span id="progress-value">${data.progress || 0}%</span></label><input type="range" name="progress" min="0" max="100" value="${data.progress || 0}" class="w-full" oninput="document.getElementById('progress-value').textContent = this.value + '%'"></div><div class="text-left mt-4"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ التفاصيل</button></div></form></div><div id="tab-2" class="tab-content space-y-4"><textarea id="projectDesc" name="description" placeholder="وصف موجز للمشروع" class="w-full p-2 border rounded h-24">${data.description || ''}</textarea><div class="flex items-center gap-4"><button type="button" id="generate-tasks-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg">✨ تحليل إلى مهام</button><button type="button" id="generate-risks-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">✨ تقييم المخاطر</button></div><textarea id="projectTasks" name="tasks" placeholder="المهام المقترحة..." class="w-full p-2 border rounded bg-gray-50 h-32">${data.tasks || ''}</textarea><textarea id="projectRisks" name="risks" placeholder="المخاطر المحتملة..." class="w-full p-2 border rounded bg-gray-50 h-32">${data.risks || ''}</textarea><div class="text-left mt-4"><button type="submit" form="data-form" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ التغييرات</button></div></div><div id="tab-3" class="tab-content space-y-4"><div><form id="expense-form" data-project-id="${data.id}" class="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50"><input type="date" name="date" class="p-2 border rounded" required><input type="text" name="description" placeholder="وصف المصروف" class="p-2 border rounded" required><input type="number" name="amount" placeholder="المبلغ" class="p-2 border rounded" required><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg col-span-1 sm:col-span-3">إضافة مصروف</button></form></div><div class="border rounded-lg overflow-hidden"><table class="w-full text-sm text-right"><thead><tr class="bg-gray-100"><th class="p-2">التاريخ</th><th class="p-2">الوصف</th><th class="p-2">المبلغ</th><th class="p-2"></th></tr></thead><tbody id="expense-list">${expenseRows}</tbody><tfoot><tr class="bg-gray-200 font-bold"><td class="p-2" colspan="2">الإجمالي</td><td class="p-2">${totalExpenses.toLocaleString()} SAR</td><td></td></tr></tfoot></table></div></div></div>`;
            };
            
            function renderFinanceSection() {
                const section = document.getElementById('finance');
                if (!section) return;
                const expensesByProject = state.expenses.reduce((acc, ex) => { acc[ex.projectId] = (acc[ex.projectId] || 0) + parseFloat(ex.amount || 0); return acc; }, {});
                const projectDetails = Object.entries(expensesByProject).map(([projectId, total]) => { const project = state.projects.find(p => p.id === projectId); return { name: project ? project.name : 'مشروع محذوف', total: total }; });
                const totalAllExpenses = projectDetails.reduce((sum, p) => sum + p.total, 0);
                const content = projectDetails.length > 0 ? projectDetails.map(p => `<div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center"><span class="font-semibold text-gray-700">${p.name}</span><span class="font-bold text-red-600">${p.total.toLocaleString()} SAR</span></div>`).join('') : '<p class="text-center text-gray-500">لا توجد مصروفات مسجلة.</p>';
                section.innerHTML = `<h2 class="text-3xl font-bold text-gray-800 mb-6">الملخص المالي</h2><div class="space-y-4">${content}</div><div class="mt-6 pt-4 border-t-2 flex justify-between items-center font-bold text-xl"><span class="text-gray-800">إجمالي المصروفات</span><span class="text-red-700">${totalAllExpenses.toLocaleString()} SAR</span></div>`;
            }

            const employeeHeaders = { id: 'المعرف', name: 'الاسم الكامل', jobTitle: 'المسمى الوظيفي', idNumber: 'رقم الهوية/الإقامة', phone: 'الجوال', nationality: 'الجنسية', salary: 'الراتب', religion: 'الديانة', insuranceNumber: 'رقم التأمين', hireDate: 'تاريخ التوظيف', contractEndDate: 'نهاية العقد' };
            const equipmentHeaders = { id: 'المعرف', name: 'اسم المعدة', type: 'النوع', serialNumber: 'الرقم التسلسلي', status: 'الحالة التشغيلية', condition: 'حالة المعدة', mileage: 'الممشاء/ساعات التشغيل', purchaseDate: 'تاريخ الشراء' };
            const projectHeaders = { id: 'المعرف', name: 'اسم المشروع', projectManager: 'مدير المشروع', budget: 'الميزانية', status: 'الحالة', progress: 'نسبة الإنجاز', startDate: 'تاريخ البدء', endDate: 'تاريخ الانتهاء', description: 'الوصف' };
            const expenseHeaders = { id: 'المعرف', projectId: 'معرف المشروع', date: 'التاريخ', description: 'الوصف', amount: 'المبلغ' };
            
            function exportData() {
                const wb = XLSX.utils.book_new(); const date = new Date().toISOString().split('T')[0]; const fileName = `walaa-almustaqbal-data-${date}.xlsx`;
                const createStyledSheet = (data, headerMapping, sheetName) => {
                    const dataForSheet = data.map(row => { const newRow = {}; for (const key in headerMapping) { if (Object.prototype.hasOwnProperty.call(row, key)) { newRow[headerMapping[key]] = row[key] ?? ''; } } return newRow; });
                    const ws = XLSX.utils.json_to_sheet(dataForSheet);
                    const headerStyle = { font: { name: 'Tajawal', sz: 12, bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "1F4E78" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
                    const cellStyle = { font: { name: 'Tajawal', sz: 11 }, border: { top: { style: "thin", color: { rgb: "D9D9D9" } }, bottom: { style: "thin", color: { rgb: "D9D9D9" } }, left: { style: "thin", color: { rgb: "D9D9D9" } }, right: { style: "thin", color: { rgb: "D9D9D9" } } } };
                    if (dataForSheet.length > 0) { const columnWidths = Object.keys(dataForSheet[0]).map(header => ({ wch: Math.max(header.length, ...dataForSheet.map(row => (row[header] ? String(row[header]).length : 0))) + 5 })); ws['!cols'] = columnWidths; }
                    const range = XLSX.utils.decode_range(ws['!ref']); for (let R = range.s.r; R <= range.e.r; ++R) { for (let C = range.s.c; C <= range.e.c; ++C) { const cell_ref = XLSX.utils.encode_cell({ c: C, r: R }); if (!ws[cell_ref]) continue; ws[cell_ref].s = (R === 0) ? headerStyle : cellStyle; } }
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                };
                createStyledSheet(state.employees, employeeHeaders, "الموظفين"); createStyledSheet(state.equipment, equipmentHeaders, "المعدات"); createStyledSheet(state.projects, projectHeaders, "المشاريع"); createStyledSheet(state.expenses, expenseHeaders, "المصروفات");
                XLSX.writeFile(wb, fileName);
            }
            function importData(event) {
                const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const newState = { ...state, employees: [], equipment: [], projects: [], expenses: [] };
                        const reverseHeaders = (headers) => Object.fromEntries(Object.entries(headers).map(([k, v]) => [v, k]));
                        const mapSheetData = (sheetData, reverseMap) => sheetData.map(row => { const newRow = {}; for (const key in row) { if (reverseMap[key]) newRow[reverseMap[key]] = row[key]; } if (!newRow.id) newRow.id = Date.now().toString() + Math.random().toString(16).slice(2); else newRow.id = String(newRow.id); return newRow; });
                        if (workbook.Sheets["الموظفين"]) newState.employees = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["الموظفين"]), reverseHeaders(employeeHeaders));
                        if (workbook.Sheets["المعدات"]) newState.equipment = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["المعدات"]), reverseHeaders(equipmentHeaders));
                        if (workbook.Sheets["المشاريع"]) newState.projects = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["المشاريع"]), reverseHeaders(projectHeaders));
                        if (workbook.Sheets["المصروفات"]) newState.expenses = mapSheetData(XLSX.utils.sheet_to_json(workbook.Sheets["المصروفات"]), reverseHeaders(expenseHeaders));
                        if (newState.employees.length === 0 && newState.equipment.length === 0 && newState.projects.length === 0) throw new Error("الملف فارغ أو لا يحتوي على الأوراق المطلوبة.");
                        showConfirmationModal("سيتم استبدال البيانات الحالية. هل أنت متأكد؟", () => { state = newState; saveState(); renderAll(); openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-green-600 mb-4">نجاح</h3><p>تم استيراد البيانات.</p><button onclick="closeModal()" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg">حسنًا</button></div>`); });
                    } catch (error) { openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-red-600 mb-4">خطأ</h3><p>فشل استيراد الملف: ${error.message}</p><button onclick="closeModal()" class="mt-6 bg-gray-300 px-6 py-2 rounded-lg">إغلاق</button></div>`); } finally { importFileInput.value = ''; }
                }; reader.onerror = () => { openModal(`<div class="text-center"><h3 class="text-2xl font-bold text-red-600 mb-4">خطأ</h3><p>فشل قراءة الملف.</p><button onclick="closeModal()" class="mt-6 bg-gray-300 px-6 py-2 rounded-lg">إغلاق</button></div>`); importFileInput.value = ''; }; reader.readAsArrayBuffer(file);
            }

            importFileInput.addEventListener('change', importData);
            document.body.addEventListener('input', e => { if (e.target.matches('.search-input')) { const type = e.target.dataset.type; state.searchTerms[type] = e.target.value; const contentFn = { employees: getEmployeesContent, equipment: getEquipmentContent, projects: getProjectsContent }[type]; if (contentFn) { document.getElementById(`${type}-list`).innerHTML = contentFn(); } } });
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('button'); if (!target) return;
                const { type, id } = target.dataset;
                if (target.matches('.add-btn')) { state.editingId = null; if (type === 'employees') openModal(getEmployeeForm()); if (type === 'equipment') openModal(getEquipmentForm()); if (type === 'projects') openModal(getProjectForm({})); }
                if (target.matches('.edit-btn')) { const data = state[type].find(item => item.id === id); if (data) { state.editingId = id; if (type === 'employees') openModal(getEmployeeForm(data)); if (type === 'equipment') openModal(getEquipmentForm(data)); if (type === 'projects') openModal(getProjectForm(data)); } }
                if (target.matches('.delete-btn')) { const item = state[type].find(i => i.id === id); showConfirmationModal(`هل أنت متأكد من حذف "${item?.name || 'العنصر'}"؟`, () => { state[type] = state[type].filter(i => i.id !== id); saveState(); renderAll(); }); }
                if (target.matches('.maintenance-btn')) {
                    const eq = state.equipment.find(item => item.id === id); if (!eq) return;
                    const renderHistory = (logs) => (!logs || logs.length === 0) ? '<p class="text-gray-500 text-center p-4">لا توجد سجلات.</p>' : [...logs].reverse().map(log => `<div class="border-b p-2 last:border-b-0"><p class="font-semibold text-sm text-gray-800">${formatDate(log.date)}</p><p class="text-gray-600 whitespace-pre-wrap text-sm">${log.note}</p></div>`).join('');
                    openModal(`<h3 class="text-2xl font-bold mb-4">سجل الصيانة لـ ${eq.name}</h3><div class="mb-4"><h4 class="text-lg font-semibold text-gray-700 mb-2">السجل الحالي</h4><div id="maintenance-history" class="bg-gray-50 rounded-lg border max-h-48 overflow-y-auto">${renderHistory(eq.maintenanceLog)}</div></div><div class="mb-6"><h4 class="text-lg font-semibold text-gray-700 mb-2">إضافة سجل جديد</h4><textarea id="manual-maintenance-note" class="w-full p-2 border rounded" placeholder="أضف ملاحظات الصيانة هنا..."></textarea><button id="save-manual-note-btn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">حفظ</button></div><div><h4 class="text-lg font-semibold text-gray-700 mb-2">مساعد الصيانة الذكي</h4><div class="flex items-center"><button id="generate-maintenance-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">✨ اقتراح</button><div id="maintenance-loader" class="loader hidden mr-4"></div></div><div id="maintenance-result-container" class="hidden mt-4"><label class="block text-sm font-medium text-gray-700 mb-2">الخطة المقترحة:</label><div id="maintenance-result" class="p-4 bg-gray-100 rounded-lg whitespace-pre-wrap"></div><button id="save-ai-note-btn" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">إضافة للسجل</button></div></div>`);
                    const saveMaintenanceLog = (newLog) => { if (!eq.maintenanceLog) eq.maintenanceLog = []; eq.maintenanceLog.push(newLog); saveState(); document.getElementById('maintenance-history').innerHTML = renderHistory(eq.maintenanceLog); };
                    document.getElementById('save-manual-note-btn').onclick = () => { const note = document.getElementById('manual-maintenance-note'); if (note.value.trim()) { saveMaintenanceLog({ date: new Date().toISOString().split('T')[0], note: note.value.trim() }); note.value = ''; } };
                    document.getElementById('save-ai-note-btn').onclick = () => { const note = document.getElementById('maintenance-result'); if (note.textContent.trim()) { saveMaintenanceLog({ date: new Date().toISOString().split('T')[0], note: `خطة مقترحة:\n${note.textContent.trim()}` }); document.getElementById('maintenance-result-container').classList.add('hidden'); note.textContent = ''; } };
                    document.getElementById('generate-maintenance-btn').onclick = async (btnEvent) => { const loader = document.getElementById('maintenance-loader'); const resultContainer = document.getElementById('maintenance-result-container'); const resultDiv = document.getElementById('maintenance-result'); btnEvent.target.disabled = true; loader.classList.remove('hidden'); const prompt = `Provide a simple, bullet-pointed maintenance schedule for "${eq.name}". Include daily, weekly, and monthly checks. Respond in Arabic.`; resultDiv.textContent = await callGeminiAPI(prompt); resultContainer.classList.remove('hidden'); loader.classList.add('hidden'); btnEvent.target.disabled = false; };
                }
                if (target.id === 'export-data-btn') exportData();
                if (target.id === 'import-data-btn') importFileInput.click();
                if (target.id === 'generate-summary-btn' || target.id === 'generate-safety-briefing-btn') { /* AI Logic */ }
                if (target.id === 'generate-tasks-btn' || target.id === 'generate-risks-btn') { /* AI Logic */ }
            });
            appModal.addEventListener('click', e => { if (e.target.matches('.tab-button')) { document.querySelectorAll('#modal-tabs .tab-button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(e.target.dataset.target).classList.add('active'); } if (e.target.matches('.delete-expense-btn')) { const expenseId = e.target.dataset.id; const projectId = e.target.dataset.projectId; showConfirmationModal('هل أنت متأكد من حذف المصروف؟', () => { state.expenses = state.expenses.filter(ex => ex.id !== expenseId); saveState(); const project = state.projects.find(p => p.id === projectId); if (project) openModal(getProjectForm(project)); renderFinanceSection(); }); } });
            appModal.addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; if (form.id === 'data-form') { const type = form.dataset.type, data = Object.fromEntries(new FormData(form).entries()); if (state.editingId) { const index = state[type].findIndex(item => item.id === state.editingId); if (index !== -1) state[type][index] = { ...state[type][index], ...data }; } else { data.id = Date.now().toString() + Math.random().toString(16).slice(2); state[type].push(data); } renderAll(); closeModal(); } if (form.id === 'expense-form') { const projectId = form.dataset.projectId; if (!projectId) return; const data = Object.fromEntries(new FormData(form).entries()); data.id = Date.now().toString() + Math.random().toString(16).slice(2); data.projectId = projectId; state.expenses.push(data); const project = state.projects.find(p => p.id === projectId); openModal(getProjectForm(project)); renderFinanceSection(); } saveState(); });
            
            function updateDashboard() { document.getElementById('total-employees').textContent = state.employees.length; document.getElementById('total-equipment').textContent = state.equipment.length; document.getElementById('total-projects').textContent = state.projects.length; }
            function updateDashboardHeader() { const el = document.getElementById('greeting-message'); if (!el) return; const hour = new Date().getHours(); let msg = (hour >= 5 && hour < 12) ? 'صباح الخير' : (hour >= 12 && hour < 18) ? 'طاب يومك' : 'مساء الخير'; el.textContent = msg; }
            window.closeModal = closeModal;
            function getInitialData() {
                // تم حذف البيانات التجريبية لجعل التطبيق يبدأ فارغاً
                return { 
                    employees: [], 
                    equipment: [], 
                    projects: [], 
                    expenses: [], 
                    searchTerms: { employees: '', equipment: '', projects: '' }
                };
            }

            loadState();
            renderAll();
        });
    </script>
</body>
</html>


